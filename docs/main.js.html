

<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
      main.js - Documentation
  </title>

  <link href="https://www.braintreepayments.com/images/favicon-ccda0b14.png" rel="icon" type="image/png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
  <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
  
  <link type="text/css" rel="stylesheet" href="styles/collapse.css">
  

  

  <!-- start Mixpanel -->
  <script type="text/javascript">(function(e,a){if(!a.__SV){var b=window;try{var c,l,i,j=b.location,g=j.hash;c=function(a,b){return(l=a.match(RegExp(b+"=([^&]*)")))?l[1]:null};g&&c(g,"state")&&(i=JSON.parse(decodeURIComponent(c(g,"state"))),"mpeditor"===i.action&&(b.sessionStorage.setItem("_mpcehash",g),history.replaceState(i.desiredHash||"",e.title,j.pathname+j.search)))}catch(m){}var k,h;window.mixpanel=a;a._i=[];a.init=function(b,c,f){function e(b,a){var c=a.split(".");2==c.length&&(b=b[c[0]],a=c[1]);b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,
  0)))}}var d=a;"undefined"!==typeof f?d=a[f]=[]:f="mixpanel";d.people=d.people||[];d.toString=function(b){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);b||(a+=" (stub)");return a};d.people.toString=function(){return d.toString(1)+".people (stub)"};k="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
  for(h=0;h<k.length;h++)e(d,k[h]);a._i.push([b,c,f])};a.__SV=1.2;b=e.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";c=e.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}})(document,window.mixpanel||[]);
  mixpanel.init("1919205b2da72e4da3b9b6639b444d59");</script>
  <!-- end Mixpanel -->
</head>

<body>
  <svg style="display: none;">
    <defs>
      <symbol id="linkIcon" fill="#706d77" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
      </symbol>
    </defs>
  </svg>

  <input type="checkbox" id="nav-trigger" class="nav-trigger" />
  <label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
  </label>

  <label for="nav-trigger" class="overlay"></label>

  <div class="top-nav-wrapper">
    <ul>
      <li >
        <a href="index.html">
          
            <svg fill="#6D6D6D" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              <path d="M0 0h24v24H0z" fill="none"/>
            </svg>
          
          
        </a>
      </li>

      

    </ul>
  </div>

  <nav>
    <h3 class="reference-title">
      Veryfi SDK
    </h3>

    
      <h3>
        Resources
      </h3>
      
        <a href="https://www.google.com/">google</a>
      
    

    <h3>Classes</h3><ul><li id="Client-nav"><a href="Client.html">Client</a><ul class='methods'><li data-type="method" id="Client-delete_document-nav"><a href="Client.html#delete_document">delete_document</a></li><li data-type="method" id="Client-get_document-nav"><a href="Client.html#get_document">get_document</a></li><li data-type="method" id="Client-get_documents-nav"><a href="Client.html#get_documents">get_documents</a></li><li data-type="method" id="Client-process_document-nav"><a href="Client.html#process_document">process_document</a></li><li data-type="method" id="Client-process_document_file-nav"><a href="Client.html#process_document_file">process_document_file</a></li><li data-type="method" id="Client-process_document_url-nav"><a href="Client.html#process_document_url">process_document_url</a></li><li data-type="method" id="Client-update_document-nav"><a href="Client.html#update_document">update_document</a></li></ul></li></ul>
  </nav>

  <div id="main">
    
      <h1 class="page-title">
        main.js
      </h1>
    

    
      

<section>
  <article>
    <pre class="prettyprint source linenums"><code>const {createHmac} = require('crypto');
const axios = require('axios').default;
const path = require('path');
const fs = require('fs');
const VeryfiClientError = require('./errors')

/**
 * Create instance of a Client
 * @class
 * @param {string} client_id Your Veryfi client id
 * @param {string} client_secret Your Veryfi client secret
 * @param {string} username Your Veryfi username
 * @param {string} api_key Your Veryfi API key
 * @param {string} base_url 
 * @param {string} api_version 
 * @param {Number} timeout 
 */
function Client(
        client_id,
        client_secret,
        username,
        api_key,
        base_url="https://api.veryfi.com/api/",
        api_version="v7",
        timeout=120,) {
    this.client_id = client_id;
    this.client_secret = client_secret;
    this.username = username;
    this.api_key = api_key;
    this.base_url = base_url;
    this.timeout = timeout;
    this.api_version = api_version;
    this.headers = {};
    CATEGORIES = [
        "Advertising &amp; Marketing",
        "Automotive",
        "Bank Charges &amp; Fees",
        "Legal &amp; Professional Services",
        "Insurance",
        "Meals &amp; Entertainment",
        "Office Supplies &amp; Software",
        "Taxes &amp; Licenses",
        "Travel",
        "Rent &amp; Lease",
        "Repairs &amp; Maintenance",
        "Payroll",
        "Utilities",
        "Job Supplies",
        "Grocery",
        ];
}


/**
 * Prepares the headers needed for a request.
 * @private
 * @param {Boolean} has_files Are there any files to be submitted as binary
 * @return {Object} Dictionary with headers
 */
Client.prototype._get_headers = function (has_files=false){
    const final_headers = {
        "User-Agent": "Python Veryfi-Python/1.1.1",
        "Accept": "application/json",
        "Content-Type": "application/json",
        "Client-Id": this.client_id,
    };

    final_headers['Authorization'] = `apikey ${this.username}:${this.api_key}`;

    if (has_files){
        // final_headers.pop("Content-Type", "application/x-www-form-urlencoded");
        // delete final_headers["Content-Type"];
        final_headers["Content-Type"] = "application/octet-stream"
    }
    return final_headers
}

/**
 * Get API Base URL with API Version
 * @private
 * @returns {string} Base URL to Veryfi API
 */
Client.prototype._get_url = function (){
    return this.base_url + this.api_version
}

/**
 * Generate unique signature for payload params.
 * @private
 * @param {JSON} payload_params JSON params to be sent to API request
 * @param {Number} timestamp Unix Long timestamp
 * @returns {string} Unique signature generated using the client_secret and the payload
 */
Client.prototype._generate_signature = function (payload_params, timestamp){
    var payload = `timestamp:${timestamp}`;
    for (let i=0; i&lt;Object.keys(payload_params).length; i++){
        let key = Object.keys(payload_params)[i];
        let value = payload_params[key];
        payload = `${payload},${key}:${value}`;
    }
    const secret_bytes = encodeURI(this.client_secret);
    const payload_bytes = encodeURI(payload);
    let hmac = createHmac('sha256', secret_bytes);
    hmac.update(payload_bytes);
    let tmp_signature = hmac.digest('sha256')
    var base64_signature = Buffer.from(tmp_signature).toString('base64');
    base64_signature = Buffer.from(base64_signature).toString('utf-8').trim();

    return base64_signature;
}

/**
 * Submit the HTTP request.
 * @private
 * @param {string} http_verb HTTP Method
 * @param {string} endpoint_name Endpoint name such as 'documents', 'users', etc.
 * @param {JSON} request_arguments JSON payload to send to Veryfi
 * @returns {JSON} A JSON of the response data.
 */
Client.prototype._request = async function (http_verb, endpoint_name, request_arguments, file_stream=null){
    let has_files = (Boolean(file_stream));
    let headers = this._get_headers(has_files=has_files);
    let api_url = `${this._get_url()}/partner${endpoint_name}`;

    if (this.client_secret){
        let timestamp = Date.now();
        let signature = this._generate_signature(request_arguments, timestamp=timestamp);
        headers = Object.assign(headers,
            {
                "X-Veryfi-Request-Timestamp": timestamp,
                "X-Veryfi-Request-Signature": signature,
            }
        );
    }
    try {
        const response = await axios.request({
            method : http_verb,
            url : api_url,
            headers : headers,
            data : JSON.stringify(request_arguments),
            timeout : this.timeout * 2000
        });
        return response;
    } catch (response) {
        let Err = new VeryfiClientError(response,response['response']['data'])
        let err_msg = Err.from_response(response['response'])
        throw new Error(err_msg['status'],err_msg['error'])
    }
}


/**
 * Get JSON of documents
 * @memberof Client
 * @returns {JSON} JSON object of previously processed documents
 */
Client.prototype.get_documents = async function (){
    let endpoint_name = "/documents/";
    let request_arguments = {};
    let documents = await this._request("GET", endpoint_name, request_arguments);
    if ("data" in documents){
        return documents["data"];
    }
    return documents;
}

/**
 * Retrieve document by ID
 * @memberof Client
 * @param {Number} document_id ID of the document you'd like to retrieve
 * @returns {JSON} Data extracted from the Document
 */
Client.prototype.get_document = async function (document_id) {
    let endpoint_name = `/documents/${document_id}/`;
    let request_arguments = {"id": document_id};
    let document = await this._request("GET", endpoint_name, request_arguments);
    return document['data'];
}

/**
 * Process a document and extract all the fields from it
 * @memberof Client
 * @param {String} file_path Path on disk to a file to submit for data extraction
 * @param {Array} categories List of categories Veryfi can use to categorize the document
 * @param {Boolean} delete_after_processing Delete this document from Veryfi after data has been extracted
 * @param {Object} kwargs Additional request parameters
 * @returns {JSON} Data extracted from the document
 */
Client.prototype.process_document = async function (
        file_path,
        categories = null,
        delete_after_processing = false,
        {...kwargs} = {}
    ) {
    
    let endpoint_name = "/documents/";
    if (!categories){
        categories = CATEGORIES;
    }
    let file_name = path.basename(file_path)
    const image_file = fs.readFileSync(file_path, {encoding: 'base64'});
    var base64_encoded_string = Buffer.from(image_file).toString('utf-8');
    var request_arguments = {
        "file_name": file_name,
        "file_data": base64_encoded_string,
        "categories": categories,
        "auto_delete": delete_after_processing,
    }
    request_arguments = Object.assign(request_arguments,kwargs)
    let document = await this._request("POST", endpoint_name, request_arguments)
    return document['data']
}

/**
 * Process document by sending it to Veryfi as a multipart form
 * @memberof Client
 * @param {string} file_path Path on disk to a file to submit for data extraction
 * @param {Array} categories List of categories Veryfi can use to categorize the document
 * @param {boolean} delete_after_processing Delete this document from Veryfi after data has been extracted
 * @param {Object} kwargs Additional request parameters
 * @return {JSON} Data extracted from the document
 * @function
 */
Client.prototype.process_document_file = async function (
        file_path,
        categories = null,
        delete_after_processing = false,
        {...kwargs} = {},
    ) {
    var _this = this; 
    const endpoint_name = "/documents/"
    if (!Boolean(categories)) {
        categories = CATEGORIES
    }
    
    // This line opens the file as a readable stream
    const file_stream = fs.createReadStream(file_path);
    readmeStream.on('error', console.log)
    const {size} = fs.statSync(file_path)

    // This will wait until we know the readable stream is actually valid before piping
    let file_name = path.basename(file_path)
    var request_arguments = {
        "file_name": file_name,
        "categories": categories,
        "auto_delete": delete_after_processing,
        "Content-Length": size,
    }
    request_arguments = Object.assign(request_arguments,kwargs)
    let document = await _this._request("POST", endpoint_name, request_arguments, file_stream)
    console.log(document)
    return document
}

/**
 * Process document from url and extract all the fields from it.
 * @memberof Client
 * @param {string} file_url Required if file_urls isn't specified. Publicly accessible URL to a file, e.g. "https://cdn.example.com/receipt.jpg".
 * @param {Array} file_urls Required if file_url isn't specified. List of publicly accessible URLs to multiple files, e.g. ["https://cdn.example.com/receipt1.jpg", "https://cdn.example.com/receipt2.jpg"]
 * @param {Array} categories List of categories to use when categorizing the document
 * @param {boolean} delete_after_processing Delete this document from Veryfi after data has been extracted
 * @param {int} max_pages_to_process When sending a long document to Veryfi for processing, this parameter controls how many pages of the document will be read and processed, starting from page 1.
 * @param {int} boost_mode Flag that tells Veryfi whether boost mode should be enabled. When set to 1, Veryfi will skip data enrichment steps, but will process the document faster. Default value for this flag is 0
 * @param {string} external_id Optional custom document identifier. Use this if you would like to assign your own ID to documents
 * @param {Object} kwargs Additional request parameters
 * @return {JSON} Data extracted from the document.
 */
Client.prototype.process_document_url = async function (
        file_url = null,
        categories = null,
        delete_after_processing = false,
        boost_mode = 0,
        external_id = null,
        max_pages_to_process = null,
        file_urls = null,
        {...kwargs} = {},
    ) {
    let endpoint_name = "/documents/";
    var request_arguments = {
        "auto_delete": delete_after_processing,
        "boost_mode": boost_mode,
        "categories": categories,
        "external_id": external_id,
        "file_url": file_url,
        "file_urls": file_urls,
        "max_pages_to_process": max_pages_to_process,
    };
    request_arguments = Object.assign(request_arguments,kwargs)
    return await this._request("POST", endpoint_name, request_arguments);
}

/**
 * Delete document from Veryfi
 * @memberof Client
 * @param {Number} document_id ID of the document you'd like to delete
 */
Client.prototype.delete_document = async function (document_id){
    
    let endpoint_name = `/documents/${document_id}/`;
    let request_arguments = {"id": document_id};
    await this._request("DELETE", endpoint_name, request_arguments);
}

/**
 * Update data for a previously processed document, including almost any field like `vendor`, `date`, `notes` and etc.
 *  - `veryfi_client.update_document(id, {date:"2021-01-01", notes:"look what I did")`
 * @memberof Client
 * @param {Number} document_id ID of the document you'd like to update
 * @param {Object} kwargs fields to update
 * @return {JSON} A document json with updated fields, if fields are writable. Otherwise a document with unchanged fields.
 */
Client.prototype.update_document = async function (document_id, {...kwargs} = {}){
    let endpoint_name = `/documents/${document_id}/`
    return await this._request("PUT", endpoint_name, kwargs)
}

// Exports

module.exports = Client;</code></pre>
  </article>
</section>

    


  </div>

  <br class="clear">

  <footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a>
  </footer>

  <script src="scripts/linenumber.js"></script>
  <script src="scripts/pagelocation.js"></script>

  

</body>
</html>
